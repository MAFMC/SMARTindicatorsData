---
title:
    | 
    | SMART Indicator Report: Seabird diet and productivity - New England
    | 
#date: "`r format(Sys.time(), '%B %d, %Y')`"
author: ""
always_allow_html: yes
bibliography: smartind.bib
link-citations: true
site: bookdown::bookdown_site
biblio-style: apalike
github-repo: MAFMC/SMARTindicatorsData
header-includes:
  \\usepackage{array}
favicon: favicon.ico
---

```{r, include = FALSE}
## Load packages
# library(tidyverse)
library(ggplot2)
library(tidyr)
library(dplyr)
library(ecodata)
library(plotly)
library(DT)
library(jpeg)
library(patchwork)
library(ggthemes)
library(here)
library(zoo)
library(gt)
library(kableExtra)
library(ggiraph)

knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'center', eval.after = 'fig.cap')

## Read in needed data

  ## Select the indicator and check it exists in the list
  ecodatadat <- readRDS(here::here("data-raw/ecodatadat.rds"))

  catalogdat <- readRDS(here::here("data-raw/catalogdat.rds"))
  
  techdocdat <- readRDS(here::here("data-raw/techdocdat.rds"))
  
  # match tech doc names to catalog page links if they differ
  techname <- techdocdat |>
    dplyr::filter(Varname == "catalog link") |>
    dplyr::select(IndicatorTD = Indicator, CatLink = Value) |>
    dplyr::distinct()

  lookup <- catalogdat |>
    dplyr::filter(Varname == "ecodata name") |>
    dplyr::select(Indicator, Source, Dataset = Value) |>
    dplyr::distinct() |>
    dplyr::left_join(techname, by = c("Source" = "CatLink"))


## Put all mustaches here
indicator_name <- "Seabird diet and productivity - New England"
indicator_varname <- "ALL"

# cc_name <- "{{CC_NAME}}"
# common_name <- "{{COMMON_NAME}}"
# interactive <-  ifelse(knitr::is_latex_output(), F,T)
# 

## Pull out text and stats for indicator_name

  # check for stuff that needs escaping in indicator_name and escape it so detection works
  esc_indicator_name <- stringr::str_escape(indicator_name)


  clean_catdat <- catalogdat |>
    dplyr::filter(stringr::str_detect(Indicator, esc_indicator_name),
                  !is.na(Varname))

  clean_ecodat <- ecodatadat |>
    dplyr::filter(Dataset == lookup$Dataset[lookup$Indicator == indicator_name]) 

  if(!indicator_varname %in% c("ALL")){ #matching needed if not doing them all
    clean_ecodat <- clean_ecodat |>
      dplyr::filter(Indicator == indicator_varname)
  }

  clean_techdoc <- techdocdat |>
    dplyr::filter(Indicator == lookup$IndicatorTD[lookup$Indicator == indicator_name])

```


## Indicator category

[Fill by hand, needs decision by Council]

## Indicator name

`r unique(clean_catdat$Indicator)`

Includes variable(s): `r unique(clean_ecodat$Indicator)`

## Indicator brief description

`r clean_catdat$Value[clean_catdat$Varname=="Description"]`

## Indicator visualization

`r clean_catdat$Value[clean_catdat$Varname=="Key Results and Visualizations"]`

```{r viz}

dataset <- stringr::str_extract(unique(clean_ecodat$Dataset), "(?<=::)\ *(.*)*")

# modified from code by Andy Beet from ecodata catalog https://github.com/NOAA-EDAB/catalog/blob/master/R/make_rmd.R

if (exists(paste0("plot_",dataset), where="package:ecodata", mode="function")) {
  
    at <- attributes(eval(parse(text=paste0("ecodata::plot_",dataset))))
    
    allFunctionArgs <- names(formals(eval(parse(text=paste0("ecodata::plot_",dataset)))))
    
        
    # detect if n is an argument
    isn <- any(allFunctionArgs %in% "n")
    
    n <- 10
    
    # remove n from list
    functionArgs <- allFunctionArgs[!(allFunctionArgs %in% "n")]
    
    if (length(functionArgs) == 2 | ((length(functionArgs) == 3) & (any(c("year","scale") %in% functionArgs)))) {
      # this is standard shadedRegion and report
      # check to see how many EPUs are listed in data object and/or they are "All" (shelfwide)
      indicatorData <- eval(parse(text=paste0("ecodata::",dataset)))  
      epus <- unique(indicatorData$EPU)
      if (any(c("all","na") %in% tolower(epus)) | is.null(epus)) {
        if(isn) {
          print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic',n=",n,")"))))
        } else {
          print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic')"))))
        }
      } else {
        # stock_status has no EPU. non conforming data set
        if ("mab" %in% tolower(epus)) {
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic')"))))
          }
        } 
        if (any(c("gb","gom","ne") %in% tolower(epus))) {
          # plot NewEngland Report
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland')"))))
          }       
          
        }
      }
      
    } else if (length(functionArgs) == 3 & ("EPU" %in% functionArgs )) {
      # additional EPU argument. Create 3 plots, one for each EPU
      if(isn) {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic',n=",n,")"))))
      } else {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic')"))))
      } 

      ## GB

      if(isn) {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GB',n=",n,")"))))
      } else {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GB')"))))
      } 
      

      ## GOM

      if(isn) {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GOM',n=",n,")"))))
      } else {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GOM')"))))
      } 
          
    } 
    
    if (length(functionArgs) == 3 & ("varName" %in% names(at)) ){
      # make all plots of varName and report
      for (arep in at$report) {
        for (avar in at$varName) {
          avarws <- gsub("\\s", "", avar)  
          # create varName plots
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"')"))))
          }   
          
        }
      }
      
    }
    
    if (length(functionArgs) == 3 & ("plottype" %in% names(at)) ){
      # make all plots of plottype and report
      for (arep in at$report) {
        for (avar in at$plottype) {
          avarws <- gsub("\\s", "", avar)  # remov whitespace from name
          # create varName plots
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', plottype= '",avar,"',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', plottype= '",avar,"')"))))
          }   
          print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', plottype= '",avar,"')"))))
        }
      }
      
    }
  
    if (length(functionArgs) == 4 & ("varName" %in% names(at)) ){
      newV <- names(at)[which(!(names(at) %in% c("varName","srcref","report")))]
      newVals <- at[[newV]]
      # make all plots of plottype and report
      for (arep in at$report) {

        for (avar in at$varName) {
        
          if (any(tolower(newV) == "epu")) {
            if (arep == "MidAtlantic") {
              newVals <- "MAB"
            } else {
              newVals <- c("GB","GOM")
            }
          }
          
          for (aval in newVals) {
            avarws <- gsub("\\s", "", avar)  # remove whitespace from name
            # create varName plots

            if(isn) {
              print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"' ,",newV,"= '",aval,"',n=",n,")"))))
            } else {
              print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"' ,",newV,"= '",aval,"')"))))
            }   
            
          }
        }
      }
    }
    
    if (length(functionArgs) > 4 & (all(c("varName","plottype") %in% names(at))) ) {
        # make all plots of plottype and report
        for (arep in at$report) {
          for (avar in at$varName) {
            for (atype in at$plottype) {
              avarws <- gsub("\\s", "", avar)  # remove whitespace from name
              # create varName plots
              
              if (any(tolower(functionArgs) == "epu")) {
                if (tolower(arep) == "newengland") {
                  EPUs = c("GB","GOM")
                } else {
                  EPUs <- "MAB"
                }
                
                for (aepu in EPUs) {
                  
                  if(isn) {
                    print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', EPU = '",aepu,"', varName= '",avar,"', plottype = '",atype,"',n=",n,")"))))
                  } else {
                    print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', EPU = '",aepu,"', varName= '",avar,"', plottype = '",atype,"')"))))
                  }  
                }
                
              } else {
                
                if(isn) {
                  print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"', plottype = '",atype,"',n=",n,")"))))
                } else {
                  print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"', plottype = '",atype,"')"))))
                }  
              }
            }
          }
        }
      }
  }



```


## Indicator documentation

### Are indicators available for others to use (data downloadable)?

```{r download, results='asis'}

if(stringr::str_detect(clean_catdat$Value[clean_catdat$Varname=="ecodata name"], "ecodata::")){
  cat("Yes", "\n")
}else{
  cat("Not in ecodata, need to enter info", "\n")
}
  

```

#### Where can indicators be found?

```{r where, results='asis'}

if(stringr::str_detect(clean_catdat$Value[clean_catdat$Varname=="ecodata name"], "ecodata::")){
  cat("Data: https://noaa-edab.github.io/ecodata/index.html", "\n\n")
  cat("Description: ", unique(clean_catdat$Source), "\n\n")
  cat("Technical documentation: ", unique(clean_catdat$Value[clean_catdat$Varname=="tech-doc link"]), "\n")
}else{
  cat("Not in ecodata, need to enter info", "\n")
}
  

```


#### How often are they updated? Are future updates likely?

[need sequential look at datasets for update frequency. Future requires judgement]

#### Who is the contact?

`r clean_catdat$Value[clean_catdat$Varname=="Point of contact"]`

### Gather indicator statistics

#### Units

```{r units}

# if(length(unique(clean_ecodat$Units)) == 1){
#   cat(unique(clean_ecodat$Units), "\n")
# }else{
  clean_ecodat |>
    dplyr::select(Indicator, Units) |>
    dplyr::distinct() |>
    flextable::flextable()|>
    flextable::set_table_properties(layout = "autofit")
#}

```

#### Length of time series, start and end date, periodicity

General overview: `r clean_catdat$Value[clean_catdat$Varname=="Temporal scale"]`

Indicator specifics:


```{r}

if(any(clean_ecodat$Varname %in% c("no Time Variables"))){
  clean_ecodat |>
    dplyr::select(Indicator, Varname) |>
    dplyr::distinct() |>
    flextable::flextable()|>
    flextable::set_table_properties(layout = "autofit")
}else{
  clean_ecodat |>
    dplyr::select(Indicator, EPU, Varname, Value) |>
    dplyr::filter(Varname %in% c("StartYear", "EndYear", "EstYrs", "ActualYrs")) |>
    tidyr::pivot_wider(names_from = Varname, values_from = Value) |>
    dplyr::mutate(MissingYears = EstYrs - ActualYrs) |>
    dplyr::select(Indicator, EPU, StartYear, EndYear, NumYears = ActualYrs, MissingYears) |>
    dplyr::distinct() |>
    flextable::flextable() |>
    flextable::colformat_num(big.mark = "") |>
    flextable::set_table_properties(layout = "autofit")
}
```


#### Spatial location, scale and extent

General overview: `r clean_catdat$Value[clean_catdat$Varname=="Spatial scale"]`

Indicator specifics:

```{r}

  clean_ecodat |>
    dplyr::select(Indicator, EPU) |>
    dplyr::distinct() |>
    flextable::flextable()|>
    flextable::set_table_properties(layout = "autofit")

```


#### Management scale: all species, FMP level, species level, can it be aggregated or separated to different scales?

[Classify by hand, note gridded data if available could be applied to different species ranges]

#### Uncertainty metrics

Uncertainty is captured in these variables:  

```{r uncert, results='asis'}

uncertvars <- "Lower95|SE|SD|Upper95|Standard Error|CV|lower|upper"

unique(clean_ecodat$Indicator[stringr::str_detect(clean_ecodat$Indicator, uncertvars)])
  
```


### Are methods clearly documented to obtain source data and calculate indicators?

```{r documented, results='asis'}

if(stringr::str_detect(clean_catdat$Value[clean_catdat$Varname=="ecodata name"], "ecodata::")){
  cat("Yes", "\n")
}else{
  cat("Not in ecodata, need to enter info", "\n")
}

```

#### Can the indicator be calculated from current documentation?

`r clean_techdoc$Value[clean_techdoc$Varname %in% c("Data Extraction/Analysis", "Data Extraction", "Data extraction")]`

`r clean_techdoc$Value[clean_techdoc$Varname %in% c("Data Analysis", "Data analysis")]`

#### Is code publicly available? up to date?

[Requires judgement, enter by hand]

#### Have methods changed over time?

`r clean_techdoc$Value[clean_techdoc$Varname=="MethodsChange"]`

### Are indicator underlying source data linked or easy to find?

`r clean_techdoc$Value[clean_techdoc$Varname=="Public availability statement"]`

#### Where are source data stored?

`r clean_techdoc$Value[clean_techdoc$Varname%in% c("Data Sources", "Data sources")]`

#### How/by whom are source data updated? Are future updates likely?

`r clean_techdoc$Value[clean_techdoc$Varname=="Data steward"]`

[likelihood of source data updates requires judgement, enter by hand]

#### How often are they updated?

[Update by hand, look for source, may require judgement]


## Indicator analysis/testing or history of use

### What decision or advice processes are the indicators currently used in?

`r clean_catdat$Value[clean_catdat$Varname=="Introduction to Indicator"]`

### What implications of the indicators are currently listed?

`r clean_catdat$Value[clean_catdat$Varname=="Implications"]`

### Do target, limit,  or threshold values already exist for the indicator?

[Fill by hand; if not in key results or implications, likely does not exist]

### Have the indicators been tested to ensure they respond proportionally to a change in the underlying process?

[Fill by hand; if not in introduction, key results, or implications, likely not tested]

### Are the indicators sensitive to a small change in the process, or what is the threshold of change that is detectable?

[Fill by hand; if not in introduction, key results, or implications, likely not tested]

### Is there a time lag between the process change and the indicator change? How long?

[Fill by hand; if not in introduction, key results, or implications, likely not tested]


## Comments

[Fill below by hand once above data complete]

### Additional potential links to management in addition to uses listed above


### What additional work would be needed for the Council to use the indicator? 


### What issues are caused if there is a gap or delay in data underlying the indicator



