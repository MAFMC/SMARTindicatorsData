---
title:
    | 
    | SMART Indicator Report: NE Shelf Annual Sea Surface Temperature (SST)
    | 
#date: "`r format(Sys.time(), '%B %d, %Y')`"
author: ""
always_allow_html: yes
bibliography: smartind.bib
link-citations: true
site: bookdown::bookdown_site
biblio-style: apalike
github-repo: MAFMC/SMARTindicatorsData
header-includes:
  \\usepackage{array}
favicon: favicon.ico
---

```{r, include = FALSE}
## Load packages
# library(tidyverse)
library(ggplot2)
library(tidyr)
library(dplyr)
library(ecodata)
library(plotly)
library(DT)
library(jpeg)
library(patchwork)
library(ggthemes)
library(here)
library(zoo)
library(gt)
library(kableExtra)
library(ggiraph)

knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'center', eval.after = 'fig.cap')

## Read in needed data

  ## Select the indicator and check it exists in the list
  ecodatadat <- readRDS(here::here("data-raw/ecodatadat.rds"))

  catalogdat <- readRDS(here::here("data-raw/catalogdat.rds"))
  
  techdocdat <- readRDS(here::here("data-raw/techdocdat.rds"))
  
  # match tech doc names to catalog page links if they differ
  techname <- techdocdat |>
    dplyr::filter(Varname == "catalog link") |>
    dplyr::select(IndicatorTD = Indicator, CatLink = Value) |>
    dplyr::distinct()

  lookup <- catalogdat |>
    dplyr::filter(Varname == "ecodata name") |>
    dplyr::select(Indicator, Source, Dataset = Value) |>
    dplyr::distinct() |>
    dplyr::left_join(techname, by = c("Source" = "CatLink"))


## Put all mustaches here
indicator_name <- "NE Shelf Annual Sea Surface Temperature (SST)"
indicator_varname <- "ALL"

# cc_name <- "{{CC_NAME}}"
# common_name <- "{{COMMON_NAME}}"
# interactive <-  ifelse(knitr::is_latex_output(), F,T)
# 

## Pull out text and stats for indicator_name

  # check for stuff that needs escaping in indicator_name and escape it so detection works
  esc_indicator_name <- stringr::str_escape(indicator_name)


  clean_catdat <- catalogdat |>
    dplyr::filter(stringr::str_detect(Indicator, esc_indicator_name),
                  !is.na(Varname))

  clean_ecodat <- ecodatadat |>
    dplyr::filter(Dataset == lookup$Dataset[lookup$Indicator == indicator_name]) 

  if(!indicator_varname %in% c("ALL")){ #matching needed if not doing them all
    clean_ecodat <- clean_ecodat |>
      dplyr::filter(Indicator == indicator_varname)
  }

  clean_techdoc <- techdocdat |>
    dplyr::filter(Indicator == lookup$IndicatorTD[lookup$Indicator == indicator_name])

```

# Descriptive Section

## Indicator category

```{r category, results='asis'}

keywords <- data.frame(keystring = c("water quality", "temperature", "sst", "salinity", "habitat", "warm", "cold", "gulf stream", "slopewater", "heat", "sound", "thermal",
                                     "submerged aquatic vegetation", "harmful algal",
                                     "plankton", "benthos", "benthic",
                                     "whale", "cetacean", "porpoise", "seal", "salmon", "seabird",
                                     "commercial", "recreational", "landings", "fishing", "stock", "aquaculture",
                                     "revenue", "bennet",
                                     "community", "social",
                                     "offshore wind"),
                       category = c(rep("Habitat-Physical", 12),
                                    rep("Habitat-Living", 2),
                                    rep("Food-Web-Base", 3),
                                    rep("Protected",6),
                                    rep("Fishery",6),
                                    rep("Economic",2),
                                    rep("Social",2),
                                    "Ocean-Use")
)

indname <- tolower(unique(clean_catdat$Indicator))

category <- keywords$category[stringr::str_detect(indname, keywords$keystring)] 

# Fish category is everything not mapped above
if(length(category) == 0){
  category <- "Fish"
}

category <- unique(category)

if(length(category) > 1 ) category <- paste(category, collapse = " ")

category

```

## Indicator name

`r unique(clean_catdat$Indicator)`

Includes variable(s): `r unique(clean_ecodat$Indicator)`

## Indicator brief description

`r clean_catdat$Value[clean_catdat$Varname=="Description"]`

```{r S1}
#currently a test for existence
specific.1 <- ifelse(length(clean_catdat$Value[clean_catdat$Varname=="Description"]) == 0, 0, 1)
```


## Indicator visualization

`r clean_catdat$Value[clean_catdat$Varname=="Key Results and Visualizations"]`

```{r viz}

dataset <- stringr::str_extract(unique(clean_ecodat$Dataset), "(?<=::)\ *(.*)*")

# modified from code by Andy Beet from ecodata catalog https://github.com/NOAA-EDAB/catalog/blob/master/R/make_rmd.R

if (exists(paste0("plot_",dataset), where="package:ecodata", mode="function")) {
  
    at <- attributes(eval(parse(text=paste0("ecodata::plot_",dataset))))
    
    allFunctionArgs <- names(formals(eval(parse(text=paste0("ecodata::plot_",dataset)))))
    
        
    # detect if n is an argument
    isn <- any(allFunctionArgs %in% "n")
    
    n <- 10
    
    # remove n from list
    functionArgs <- allFunctionArgs[!(allFunctionArgs %in% "n")]
    
    if (length(functionArgs) == 2 | ((length(functionArgs) == 3) & (any(c("year","scale") %in% functionArgs)))) {
      # this is standard shadedRegion and report
      # check to see how many EPUs are listed in data object and/or they are "All" (shelfwide)
      indicatorData <- eval(parse(text=paste0("ecodata::",dataset)))  
      epus <- unique(indicatorData$EPU)
      if (any(c("all","na") %in% tolower(epus)) | is.null(epus)) {
        if(isn) {
          print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic',n=",n,")"))))
        } else {
          print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic')"))))
        }
      } else {
        # stock_status has no EPU. non conforming data set
        if ("mab" %in% tolower(epus)) {
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic')"))))
          }
        } 
        if (any(c("gb","gom","ne") %in% tolower(epus))) {
          # plot NewEngland Report
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland')"))))
          }       
          
        }
      }
      
    } else if (length(functionArgs) == 3 & ("EPU" %in% functionArgs )) {
      # additional EPU argument. Create 3 plots, one for each EPU
      if(isn) {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic',n=",n,")"))))
      } else {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='MidAtlantic')"))))
      } 

      ## GB

      if(isn) {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GB',n=",n,")"))))
      } else {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GB')"))))
      } 
      

      ## GOM

      if(isn) {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GOM',n=",n,")"))))
      } else {
        print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report='NewEngland',EPU='GOM')"))))
      } 
          
    } 
    
    if (length(functionArgs) == 3 & ("varName" %in% names(at)) ){
      # make all plots of varName and report
      for (arep in at$report) {
        for (avar in at$varName) {
          avarws <- gsub("\\s", "", avar)  
          # create varName plots
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"')"))))
          }   
          
        }
      }
      
    }
    
    if (length(functionArgs) == 3 & ("plottype" %in% names(at)) ){
      # make all plots of plottype and report
      for (arep in at$report) {
        for (avar in at$plottype) {
          avarws <- gsub("\\s", "", avar)  # remov whitespace from name
          # create varName plots
          if(isn) {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', plottype= '",avar,"',n=",n,")"))))
          } else {
            print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', plottype= '",avar,"')"))))
          }   
          print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', plottype= '",avar,"')"))))
        }
      }
      
    }
  
    if (length(functionArgs) == 4 & ("varName" %in% names(at)) ){
      newV <- names(at)[which(!(names(at) %in% c("varName","srcref","report")))]
      newVals <- at[[newV]]
      # make all plots of plottype and report
      for (arep in at$report) {

        for (avar in at$varName) {
        
          if (any(tolower(newV) == "epu")) {
            if (arep == "MidAtlantic") {
              newVals <- "MAB"
            } else {
              newVals <- c("GB","GOM")
            }
          }
          
          for (aval in newVals) {
            avarws <- gsub("\\s", "", avar)  # remove whitespace from name
            # create varName plots

            if(isn) {
              print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"' ,",newV,"= '",aval,"',n=",n,")"))))
            } else {
              print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"' ,",newV,"= '",aval,"')"))))
            }   
            
          }
        }
      }
    }
    
    if (length(functionArgs) > 4 & (all(c("varName","plottype") %in% names(at))) ) {
        # make all plots of plottype and report
        for (arep in at$report) {
          for (avar in at$varName) {
            for (atype in at$plottype) {
              avarws <- gsub("\\s", "", avar)  # remove whitespace from name
              # create varName plots
              
              if (any(tolower(functionArgs) == "epu")) {
                if (tolower(arep) == "newengland") {
                  EPUs = c("GB","GOM")
                } else {
                  EPUs <- "MAB"
                }
                
                for (aepu in EPUs) {
                  
                  if(isn) {
                    print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', EPU = '",aepu,"', varName= '",avar,"', plottype = '",atype,"',n=",n,")"))))
                  } else {
                    print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', EPU = '",aepu,"', varName= '",avar,"', plottype = '",atype,"')"))))
                  }  
                }
                
              } else {
                
                if(isn) {
                  print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"', plottype = '",atype,"',n=",n,")"))))
                } else {
                  print(eval(parse(text=paste0("ecodata::plot_",dataset,"(report= '",arep,"', varName= '",avar,"', plottype = '",atype,"')"))))
                }  
              }
            }
          }
        }
      }
  }



```

# SMART Attribute Section

## Indicator documentation

### Are indicators available for others to use (data downloadable)?

```{r download, results='asis'}

if(stringr::str_detect(clean_catdat$Value[clean_catdat$Varname=="ecodata name"], "ecodata::")){
  cat("Yes", "\n")
  measurable.1 <- 1
}else{
  cat("Not in ecodata, need to enter info", "\n")
  measurable.1 <- 0
}
  


```

#### Where can indicators be found?

```{r where, results='asis'}

if(stringr::str_detect(clean_catdat$Value[clean_catdat$Varname=="ecodata name"], "ecodata::")){
  cat("Data: https://noaa-edab.github.io/ecodata/index.html", "\n\n")
  cat("Description: ", unique(clean_catdat$Source), "\n\n")
  cat("Technical documentation: ", unique(clean_catdat$Value[clean_catdat$Varname=="tech-doc link"]), "\n")
  measurable.2 <- 1
}else{
  cat("Not in ecodata, need to enter info", "\n")
  measurable.2 <- 0
}
  

```


#### How often are they updated? Are future updates likely?

[need sequential look at datasets for update frequency. Future requires judgement]

#### Who is the contact?

`r clean_catdat$Value[clean_catdat$Varname=="Point of contact"]`

```{r M3}
#currently a test for existence
measurable.3 <- ifelse(length(clean_catdat$Value[clean_catdat$Varname=="Point of contact"]) == 0, 0, 1)
```

### Gather indicator statistics

#### Units

```{r units}

specific.2 <- ifelse(length(unique(clean_ecodat$Units)) == 0, 0, 1)
if(length(unique(clean_ecodat$Units)) == 1 & any(is.na(clean_ecodat$Units)|stringr::str_detect(unique(clean_ecodat$Units), "no Units field"))) specific.2 <- 0 #either NA or no units
if(length(unique(clean_ecodat$Units)) > 1 & any(is.na(clean_ecodat$Units)|stringr::str_detect(unique(clean_ecodat$Units), "no Units field"))) specific.2 <- 0.5 #some NA

# if(length(unique(clean_ecodat$Units)) == 1){
#   cat(unique(clean_ecodat$Units), "\n")
# }else{
  clean_ecodat |>
    dplyr::select(Indicator, Units) |>
    dplyr::distinct() |>
    flextable::flextable()|>
    flextable::set_table_properties(layout = "autofit")
#}

```

#### Length of time series, start and end date, periodicity

General overview: `r clean_catdat$Value[clean_catdat$Varname=="Temporal scale"]`

```{r T1}
#currently a test for existence
timebound.1 <- ifelse(length(clean_catdat$Value[clean_catdat$Varname=="Temporal scale"]) == 0, 0, 1)
```

Indicator specifics:

```{r}

if(any(clean_ecodat$Varname %in% c("no Time Variables"))){
  timebound.2 <- 0 #no time variables, so not recent
  
  clean_ecodat |>
    dplyr::select(Indicator, Varname) |>
    dplyr::distinct() |>
    flextable::flextable()|>
    flextable::set_table_properties(layout = "autofit")
  
}else{
  #end date >2023 for 2025 report = 1 Time-bound, 2020-2023 = 0.5, <2020 = 0
  # generalize to when this report is posted
  curryr <- as.numeric(format(Sys.Date(), "%Y"))
  
  maxendyr <- clean_ecodat |>
    dplyr::select(Indicator, EPU, Varname, Value) |>
    dplyr::filter(Varname %in% c("EndYear")) |>
    tidyr::pivot_wider(names_from = Varname, values_from = Value) |>
    dplyr::select(EndYear) |>
    dplyr::distinct() |>
    dplyr::summarise(maxyr = max(EndYear, na.rm=TRUE))
    
  if(curryr-maxendyr$maxyr <= 1) timebound.2 <- 1
  if(curryr-maxendyr$maxyr >=1 &  curryr-maxendyr$maxyr < 5) timebound.2 <- 0.5
  if(curryr-maxendyr$maxyr >= 5) timebound.2 <- 0

  clean_ecodat |>
    dplyr::select(Indicator, EPU, Varname, Value) |>
    dplyr::filter(Varname %in% c("StartYear", "EndYear", "EstYrs", "ActualYrs")) |>
    tidyr::pivot_wider(names_from = Varname, values_from = Value) |>
    dplyr::mutate(MissingYears = EstYrs - ActualYrs) |>
    dplyr::select(Indicator, EPU, StartYear, EndYear, NumYears = ActualYrs, MissingYears) |>
    dplyr::distinct() |>
    flextable::flextable() |>
    flextable::colformat_num(big.mark = "") |>
    flextable::set_table_properties(layout = "autofit")

}

```


#### Spatial location, scale and extent

General overview: `r clean_catdat$Value[clean_catdat$Varname=="Spatial scale"]`

```{r S3}
#currently a test for existence
specific.3 <- ifelse(length(clean_catdat$Value[clean_catdat$Varname=="Description"]) == 0, 0, 1)
```

Indicator specifics:

```{r}

  clean_ecodat |>
    dplyr::select(Indicator, EPU) |>
    dplyr::distinct() |>
    flextable::flextable()|>
    flextable::set_table_properties(layout = "autofit")

```


#### Management scale: all species, FMP level, species level, can it be aggregated or separated to different scales?

[Classify by hand, note gridded data if available could be applied to different species ranges]

#### Uncertainty metrics

Uncertainty is captured in these variables:  

```{r uncert, results='asis'}

uncertvars <- "Lower95|SE|se_|SD|Upper95|Standard Error|CV|lower|upper|LCI|UCI"

unique(clean_ecodat$Indicator[stringr::str_detect(clean_ecodat$Indicator, uncertvars)])


#currently a test for existence
specific.4 <- ifelse(length(unique(clean_ecodat$Indicator[stringr::str_detect(clean_ecodat$Indicator, uncertvars)])) == 0, 0, 1)

  
```


### Are methods clearly documented to obtain source data and calculate indicators?

```{r documented, results='asis'}

if(stringr::str_detect(clean_catdat$Value[clean_catdat$Varname=="ecodata name"], "ecodata::")){
  cat("Yes", "\n")
  specific.5 <- 1
}else{
  cat("Not in ecodata, need to enter info", "\n")
  specific.5 <- 0
}

```

#### Can the indicator be calculated from current documentation?

`r clean_techdoc$Value[clean_techdoc$Varname %in% c("Data Extraction/Analysis", "Data Extraction", "Data extraction")]`

`r clean_techdoc$Value[clean_techdoc$Varname %in% c("Data Analysis", "Data analysis")]`

#### Is code publicly available? up to date?

```{r codeS6, results='asis'}

# search for a github link in the tech doc page
if(dim(dplyr::filter(clean_techdoc, stringr::str_detect(clean_techdoc$Value, "https://github.com/")))[1] > 0){
  cat("GitHub code repository linked", "\n")
  specific.6 <- 1
}else{
  cat("No", "\n")
  specific.6 <- 0
}

# existence of link will be considered available, can't tell up to date

```


#### Have methods changed over time?

`r clean_techdoc$Value[clean_techdoc$Varname=="MethodsChange"]`

### Are indicator underlying source data linked or easy to find?

`r clean_techdoc$Value[clean_techdoc$Varname=="Public availability statement"]`

```{r M4}
#currently a test for existence
measurable.4 <- ifelse(length(clean_catdat$Value[clean_techdoc$Varname=="Public availability statement"]) == 0, 0, 1)

#search for the phrase "not publically available" and assign 0 for that
if(dim(dplyr::filter(clean_techdoc, stringr::str_detect(clean_techdoc$Value, "are NOT pub|are not pub")))[1] > 0){
  measurable.4 <- 0
}

```


#### Where are source data stored?

`r clean_techdoc$Value[clean_techdoc$Varname%in% c("Data Sources", "Data sources")]`

```{r M5}
#currently a test for existence
measurable.5 <- ifelse(length(clean_techdoc$Value[clean_techdoc$Varname%in% c("Data Sources", "Data sources")]) == 0, 0, 1)

```

#### How/by whom are source data updated? Are future updates likely?

`r clean_techdoc$Value[clean_techdoc$Varname=="Data steward"]`

```{r M6}
#currently a test for existence
measurable.6 <- ifelse(length(clean_techdoc$Value[clean_techdoc$Varname=="Data steward"]) == 0, 0, 1)

```

[likelihood of source data updates requires judgement, enter by hand]

#### How often are they updated?

[Update by hand, look for source, may require judgement]


## Indicator analysis/testing or history of use

### What decision or advice processes are the indicators currently used in?

`r clean_catdat$Value[clean_catdat$Varname=="Introduction to Indicator"]`

```{r R1}
# These are in the SOE so we'll count them as being part of an "advice process" for now
#currently a test for existence
relevant.1 <- ifelse(length(clean_catdat$Value[clean_catdat$Varname=="Introduction to Indicator"]) == 0, 0, 1)

```

### What implications of the indicators are currently listed?

`r clean_catdat$Value[clean_catdat$Varname=="Implications"]`

```{r R2}
#currently a test for existence
relevant.2 <- ifelse(length(clean_catdat$Value[clean_catdat$Varname=="Implications"]) == 0, 0, 1)

```

### Do target, limit,  or threshold values already exist for the indicator?

```{r targlimthreshr3, results='asis'}

if(dim(dplyr::filter(clean_catdat, stringr::str_detect(clean_catdat$Value, "target|limit|threshold")))[1] > 0){
  cat("Target, limit, or threshold terms detected", "\n")
  relevant.3 <- 1
}else{
  cat("No", "\n")
  relevant.3 <- 0
}

```


### Have the indicators been tested to ensure they respond proportionally to a change in the underlying process?

```{r A1, results='asis'}
#currently a weak test for existence
if(dim(dplyr::filter(clean_techdoc, stringr::str_detect(clean_techdoc$Value, "simulation|simulated|test")))[1] > 0){
  cat("Simulation or test terms detected", "\n")
  attainable.1 <- 1
}else{
  cat("No", "\n")
  attainable.1 <- 0
}

```

### Are the indicators sensitive to a small change in the process, or what is the threshold of change that is detectable?

```{r A2, results='asis'}
#currently a weak test for existence
if(dim(dplyr::filter(clean_techdoc, stringr::str_detect(clean_techdoc$Value, "sensitivity|sensitive|detection|detect")))[1] > 0){
  cat("Sensitivity terms detected", "\n")
  attainable.2 <- 1
}else{
  cat("Unknown", "\n")
  attainable.2 <- 0
}

```

### Is there a time lag between the process change and the indicator change? How long?

```{r A3, results='asis'}
#currently a weak test for existence
if(dim(dplyr::filter(clean_techdoc, stringr::str_detect(clean_techdoc$Value, "lagging indicator|time lag")))[1] > 0){
  cat("Lag terms detected", "\n")
  attainable.3 <- 1
}else{
  cat("Unknown", "\n")
  attainable.3 <- 0
}

```

# SMART rating

```{r SMART}

indratings <- c("Described" = specific.1, "Units" = specific.2, "Spatial" = specific.3, "Uncertainty" = specific.4, 
                "Methods" = specific.5, "Code" = specific.6,
             "Available" =  measurable.1, "Online" = measurable.2, "Contact" = measurable.3, "SourceDat" = measurable.4, 
             "SourceAvail" = measurable.5, "SourceContact" = measurable.6,
             "Tested" = attainable.1, "Sensitivity" = attainable.2, "TimeLag" = attainable.3,
             "Advice" = relevant.1, "Implications" = relevant.2, "TargThresh" = relevant.3,
             "Frequency" = timebound.1, "Updated" = timebound.2)

ratings <- stack(indratings)

colnames(ratings) <- c("Rating", "Attribute")

ratings$Element <- c(rep("Specific", 6),
                     rep("Measurable", 6),
                     rep("Achievable", 3),
                     rep("Relevant", 3),
                     rep("Timebound", 2))

ratings$Indicator <- unique(clean_catdat$Indicator)
ratings$Category <- category

ratings <- ratings[,c("Category", "Indicator", "Element", "Attribute", "Rating")]

elements <- ratings |>
  dplyr::group_by(Element) |>
  dplyr::summarise(ElementRating = mean(Rating, na.rm=TRUE))

overall <- elements |>
  dplyr::summarise(OverallRating = mean(ElementRating, na.rm=TRUE))

ratingsumm <- ratings |>
  dplyr::left_join(elements) |>
  dplyr::mutate(OverallRating = overall$OverallRating)

outfile <- paste0(here::here("data-raw/indratings/"), indicator_name, "_ratingsumm.csv")

write.csv(ratingsumm, outfile)

flextable::flextable(ratingsumm)

```


## Comments

[Fill below by hand once above data complete]

### Additional potential links to management in addition to uses listed above


### What additional work would be needed for the Council to use the indicator? 


### What issues are caused if there is a gap or delay in data underlying the indicator



